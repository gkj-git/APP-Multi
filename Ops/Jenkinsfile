pipeline {
  agent any
  environment {
    AWS_ACCOUNT_ID = "${AWS_ACCOUNT_ID}"
    AWS_REGION = "${AWS_REGION}"
    ECR_REPO = "Mutiverse"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Install') {
      steps { sh 'npm ci' }
    }
    stage('Test') {
      steps {
        sh 'npm test'
        // Sonar analysis (example)
        sh '''
          sonar-scanner \
            -Dsonar.projectKey=Mutiverse \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.login=$SONAR_TOKEN
        '''
      }
    }
    stage('Build & Scan') {
      steps {
        sh 'docker build -t Mutiverse:$GIT_COMMIT .'
        sh 'trivy image --severity HIGH,CRITICAL Mutiverse:$GIT_COMMIT || true'
      }
    }
    stage('Push to ECR') {
      steps {
        sh '''
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.$AWS_REGION.amazonaws.com
          docker tag Mutiverse:$GIT_COMMIT ${AWS_ACCOUNT_ID}.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$GIT_COMMIT
          docker push ${AWS_ACCOUNT_ID}.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$GIT_COMMIT
        '''
      }
    }
    stage('Deploy to EKS via ArgoCD') {
      steps {
        sh 'kubectl apply -f k8s/argo-app.yaml --kubeconfig $KUBECONFIG'
      }
    }
  }
  post {
    always { archiveArtifacts artifacts: '**/target/*.jar', allowEmptyArchive: true }
  }
}
